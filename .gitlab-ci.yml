stages:
  - build
  - deploy

###########################
# DEVELOP BRANCH PIPELINE #
###########################

build-react-develop:
  stage: build
  only:
    - develop
  tags:
    - halazone-builder
  script:
    - echo "Installing dependencies..."
    - npm install
    - echo "Copying .env.development to .env"
    - cp .env.development .env
    - echo "Building React app for development..."
    - unset CI
    - npm run build
  artifacts:
    paths:
      - build/
    expire_in: 1 hour

deploy-react-develop:
  stage: deploy
  script:
    - powershell.exe ./deploy-scripts/develop-deploy.ps1
  environment:
    name: dev
  only:
    - develop
  tags:
    - halazone-dev-publish
  dependencies:
    - build-react-develop

###########################
# STAGING BRANCH PIPELINE #
###########################

build-react-staging:
  stage: build
  only:
    - staging
  tags:
    - halazone-builder
  script:
    - echo "Installing dependencies..."
    - npm ci
    - echo "Copying .env.staging to .env"
    - cp .env.staging .env
    - echo "Building React app for staging..."
    - unset CI
    - npm run build
  artifacts:
    paths:
      - build/
    expire_in: 1 hour

deploy-react-staging:
  stage: deploy
  script:
    - powershell.exe ./deploy-scripts/staging-deploy.ps1
  environment:
    name: staging
  only:
    - staging
  tags:
    - halazone-dev-publish
  dependencies:
    - build-react-staging
stages:
  - build
  - deploy

###########################
# DEVELOP BRANCH PIPELINE #
###########################

build-react-develop:
  stage: build
  only:
    - develop
  tags:
    - halazone-builder
  script:
    - echo "Installing dependencies..."
    - npm install
    - echo "Copying .env.development to .env"
    - cp .env.development .env
    - echo "Building React app for development..."
    - unset CI
    - npm run build
  artifacts:
    paths:
      - build/
    expire_in: 1 hour

deploy-react-develop:
  stage: deploy
  only:
    - develop
  script:
    - powershell.exe ./deploy-scripts/deploy-script.ps1 Development
  environment:
    name: dev
  tags:
    - halazone-dev-publish
  dependencies:
    - build-react-develop

###########################
# STAGING BRANCH PIPELINE #
###########################

build-react-staging:
  stage: build
  only:
    - staging
  tags:
    - halazone-builder
  script:
    - echo "Installing dependencies..."
    - npm ci
    - echo "Copying .env.staging to .env"
    - cp .env.staging .env
    - echo "Building React app for staging..."
    - unset CI
    - npm run build
  artifacts:
    paths:
      - build/
    expire_in: 1 hour

deploy-react-staging:
  stage: deploy
  only:
    - staging
  script:
    - powershell.exe ./deploy-scripts/deploy-script.ps1 Staging
  environment:
    name: staging
  tags:
    - halazone-dev-publish
  dependencies:
    - build-react-staging


##############################
# PRODUCTION BRANCH PIPELINE #
##############################

build-react-production:
  stage: build
  only:
    - production
  tags:
    - halazone-builder
  script:
    - echo "Installing dependencies..."
    - npm ci
    - echo "Building React app for production..."
    - unset CI
    - npm run build
  artifacts:
    paths:
      - build/
    expire_in: 1 hour

deploy-react-production:
  stage: deploy
  only:
    - production
  script:
    - powershell.exe ./deploy-scripts/deploy-script.ps1 Production
  environment:
    name: production
  tags:
    - halazone-prod-publish
  dependencies:
    - build-react-production
